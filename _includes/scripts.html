<script src="{{ '/assets/js/main.min.js' | relative_url }}"></script>
<script>
	(function() {
		function getDocEl() {
			return document.scrollingElement || document.documentElement;
		}

			function ensureSpacers(desiredTop) {
				var docEl = getDocEl();
				var maxScroll = Math.max(0, docEl.scrollHeight - window.innerHeight);
				var needBottom = Math.max(0, desiredTop - maxScroll);

				// Never add top spacer: keep the top tight to avoid visible blank space
				var topSpacer = document.getElementById('anchor-scroll-spacer-top');
				if (topSpacer) topSpacer.style.height = '0px';

				var bottomSpacer = document.getElementById('anchor-scroll-spacer-bottom');
				if (!bottomSpacer) {
					bottomSpacer = document.createElement('div');
					bottomSpacer.id = 'anchor-scroll-spacer-bottom';
					bottomSpacer.style.cssText = 'width:100%;height:0;visibility:hidden;pointer-events:none;';
					document.body.appendChild(bottomSpacer);
				}

				// Add a small buffer (16px) so scrollTo has headroom
				bottomSpacer.style.height = needBottom > 0 ? (needBottom + 16) + 'px' : '0px';
			}

		function centerScrollTo(el) {
			if (!el) return;
			var masthead = document.querySelector('.masthead');
			var offsetTop = el.getBoundingClientRect().top + window.pageYOffset;
			var desiredTop = offsetTop - (window.innerHeight / 2) + (el.offsetHeight / 2);
			if (masthead) desiredTop -= masthead.offsetHeight;

			ensureSpacers(desiredTop);

			// Recompute after spacers applied
			var newOffsetTop = el.getBoundingClientRect().top + window.pageYOffset;
			var targetY = newOffsetTop - (window.innerHeight / 2) + (el.offsetHeight / 2);
			if (masthead) targetY -= masthead.offsetHeight;

			var docEl = getDocEl();
			var maxScroll = Math.max(0, docEl.scrollHeight - window.innerHeight);
			targetY = Math.min(Math.max(targetY, 0), maxScroll);

			window.scrollTo({ top: targetY, behavior: 'smooth' });
		}

		function isSamePageLink(a) {
			try {
				var url = new URL(a.href, window.location.href);
				return url.pathname === window.location.pathname && url.hash;
			} catch (e) { return false; }
		}

		function handleHash(hash) {
			if (!hash) return;
			var id = decodeURIComponent(hash.replace('#', ''));
			var el = document.getElementById(id);
			if (!el) el = document.querySelector('[id="' + (window.CSS && CSS.escape ? CSS.escape(id) : id) + '"]');
			if (!el) return;
			// Let browser jump first (so the URL updates and default behavior occurs), then recenter
			setTimeout(function(){ centerScrollTo(el); }, 10);
		}

		document.addEventListener('click', function (e) {
			var a = e.target.closest('a[href*="#"]');
			if (!a || !isSamePageLink(a)) return;
			var hash = a.hash;
			if (!hash) return;
			e.preventDefault();
			history.pushState(null, '', hash);
			handleHash(hash);
		}, true);

		window.addEventListener('load', function(){ handleHash(window.location.hash); });
		window.addEventListener('hashchange', function(){ handleHash(window.location.hash); });
	})();
	</script>

<script>
	// Prevent reload when clicking masthead links that target the current page path
	(function(){
		function samePath(a) {
			try {
				var u = new URL(a.href, window.location.href);
				var ap = u.pathname.replace(/index\.html$/, '');
				var cp = window.location.pathname.replace(/index\.html$/, '');
				if (ap !== '/' && ap.endsWith('/')) ap = ap.slice(0, -1);
				if (cp !== '/' && cp.endsWith('/')) cp = cp.slice(0, -1);
				return ap === cp;
			} catch(e) { return false; }
		}
		document.addEventListener('click', function(e){
			var a = e.target.closest('.masthead a[href]');
			if (!a) return;
			if (samePath(a)) {
				e.preventDefault();
			}
		}, true);
	})();
</script>

{% include analytics.html %}
{% include fetch_google_scholar_stats.html %}
